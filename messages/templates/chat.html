{% extends "base.html" %}

{% block title %} Chat  {% endblock %}

{% block content %}
<div class="container mt-4" style="max-width: 700px;">
    <h4 class="mb-3">Chat with User {{user_id}}</h4>

    <!--chat box-->
    <div id="chatbox" class="border rounded p-3 mb-3" style="height: 400px; overflow-y: auto; background-color: cornflowerblue;">
    <!--AJAX will insert information at here-->
    </div>

    <!--send message-->
    <form id="chat-form" class="mt-3">
        <div class="input-group">
            <textarea class="form-control" id="msg" name="content" rows="2" placeholder="Type your message..."></textarea>
            <button class="btn btn-primary" type="submit">Send</button>
        </div>
    </form>
</div>

<script>
const userId = parseInt ("{{ user_id }}"); //target chat partner

//load data (from routes get JSON)
function loadMessages(){
    fetch(`messages/chat/${userId}/json`) //send request to backend
    .then(response=> response.json()) //convert the returned data into js obect
    .then(data=> {
        let chatBox = document.getElementById("chat-box");
        chatBox.innerHTML=""; //clear old content

        data.forEach(msg => {
            if (msg.sender ==="Me"){
                //sent by myself (right)
                chatBox.innerHTML +=`
                <div class="d-flex justify-content-end mb-2">
                    <div class="p-2 rounded bg-primary text-white" style="max-width: 60%">
                        ${msg.content}
                        <div class="small text-end text-light">${msg.time}</div>
                    </div>
                </div>`; 
            } else{
                //sent by others (left)
                chatBox.innerHTML +=`
                <div class="d-flex justify-content-start mb-2">
                    <div class="p-2 rounded bg-secondary text-white" style="max-width: 60%">
                        ${msg.content}
                        <div class="small text-end text-light">${msg.time}</div>
                    </div>
                </div>`; 
            }
        });
        //scroll to the bottom
        chatBox.scrollTop = chatBox.scrollHeight;
    });
}
//
loadMessages();

// refresh 3s 1time
setInterval(loadMessages, 3000);

//sent message
document.getElementById("chat-form").addEventListener("submit", function(e){
    e.preventDefault(); //prevent automatic refresh
    let content = document.getElementById("msg").value;

    alert("Sending to : /messages/send/" + userId + "with content=" + content);

    fetch(`messages/send/${userId}`,{
        method:"POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body:`content=${encodeURIComponent(content)}`
    })
    .then(response=> response.json())
    .then(data =>{
        console.log("Send response", data); //test
        if(data.status === "ok"){
            document.getElementById("msg").value = ""; //clear
            loadMessages(); //refresh immediately after send 
        } else{
            alert(data.message); //test
        }
    });
});
</script>
{% endblock %}
