{% extends "base.html" %}
{% block title %} Manage Transactions {% endblock %}

{% block content %}
<style>
  body {
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, oklch(83.693% 0.02258 17.382), lch(91.75% 2.15 19.27));
    min-height: 100vh;
  }
</style>

<div class="container-fluid py-4" style="min-height: calc(100vh - 80px);">
  <div class="row justify-content-center">
    <div class="col-lg-11">
      <div class="card shadow border-0">
        <!-- header -->
          <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-light btn-sm me-4">
            <i class="bi bi-arrow-left">Back</i>
         </a>
        <div class="card-header bg-dark text-white text-center fw-bold fs-4">
          <i class="bi bi-cash-coin"></i> Manage Transaction
        </div>

        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-hover table-striped align-middle text-center mb-0">
              <thead class="table-dark">
                <tr>
                  <th>#</th>
                  <th>Product</th>
                  <th>Buyer</th>
                  <th>Seller</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Deadline</th>
                  <th>Proof</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for tx in transactions %}
                <tr>
                  <td>{{ tx.id }}</td>
                  <td>{{ tx.product.name }}</td>
                  <td>{{ tx.buyer.name }}</td>
                  <td>{{ tx.seller.name }}</td>
                  <td>
                    {% if tx.status == "pending" %}
                      <span class="badge bg-warning text-dark px-3 py-2">Pending</span>
                    {% elif tx.status == "accepted" %}
                      <span class="badge bg-primary px-3 py-2">Accepted</span>
                    {% elif tx.status == "shipped" %}
                      <span class="badge bg-info text-dark px-3 py-2">Shipped</span>
                    {% elif tx.status == "completed" %}
                      <span class="badge bg-success px-3 py-2">Completed</span>
                    {% elif tx.status == "cancelled" %}
                      <span class="badge bg-danger px-3 py-2">Cancelled</span>
                    {% else %}
                      {{ tx.status }}
                    {% endif %}
                  </td>
                  <td>{{ tx.created_at.strftime('%Y-%m-%d') if tx.created_at else '-' }}</td>
                  <td>
                    {% if tx.shipped_at %}
                      {{ (tx.shipped_at + timedelta(days=5)).strftime('%Y-%m-%d') }}
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td>
                    {% if tx.proof %}
                      {% if tx.proof.endswith(".pdf") %}
                        <a href="{{ url_for('static', filename=tx.proof) }}" target="_blank" class="btn btn-outline-secondary btn-sm">
                          <i class="bi bi-file-earmark-pdf-fill text-danger"></i> View PDF
                        </a>
                      {% else %}
                        <a href="{{ url_for('static', filename=tx.proof) }}" target="_blank">
                          <img src="{{ url_for('static', filename=tx.proof) }}" 
                               alt="Proof" class="img-thumbnail" style="max-width: 80px;">
                        </a>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">No proof</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="d-grid gap-2">
                      <!-- Update Status -->
                      <form action="{{ url_for('admin.update_transaction', transaction_id=tx.id) }}" 
                            method="POST" class="d-inline">
                        <select name="new_status" class="form-select form-select-sm d-inline w-auto mb-2">
                          {% if tx.status == "pending" %}
                            <option value="pending" selected>Pending</option>
                          {% else %}
                            <option value="pending">Pending</option>
                          {% endif %}

                          {% if tx.status == "accepted" %}
                            <option value="accepted" selected>Accepted</option>
                          {% else %}
                            <option value="accepted">Accepted</option>
                          {% endif %}

                          {% if tx.status == "shipped" %}
                            <option value="shipped" selected>Shipped</option>
                          {% else %}
                            <option value="shipped">Shipped</option>
                          {% endif %}

                          {% if tx.status == "completed" %}
                            <option value="completed" selected>Completed</option>
                          {% else %}
                            <option value="completed">Completed</option>
                          {% endif %}

                          {% if tx.status == "cancelled" %}
                            <option value="cancelled" selected>Cancelled</option>
                          {% else %}
                            <option value="cancelled">Cancelled</option>
                          {% endif %}
                        </select>
                        <button type="submit" class="btn btn-sm btn-outline-primary">Update</button>
                      </form>

                      <!-- Delete Transaction -->
                      <form action="{{ url_for('admin.delete_transaction', transaction_id=tx.id) }}" 
                            method="POST" style="display:inline;">
                        <button type="submit" class="btn btn-sm btn-outline-danger"
                                onclick="return confirm('Are you sure you want to delete this transaction?');">
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}