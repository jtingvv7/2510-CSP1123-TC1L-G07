{% extends "base.html" %}
{% block title %} Manage Reports {% endblock %}

{% block content %}
<style>
  body {
    margin: 0;
    padding: 0;
    background: linear-gradient(135deg, oklch(83.693% 0.02258 17.382), lch(91.75% 2.15 19.27));
    min-height: 100vh;
  }
</style>

<div class="container-fluid py-4" style="min-height: calc(100vh - 80px);">
  <div class="row justify-content-center">
    <div class="col-lg-11">
      <div class="card shadow border-0">
          <a href="{{ url_for('admin.dashboard') }}" class="btn btn-outline-light btn-sm me-4">
            <i class="bi bi-arrow-left">Back</i>
          </a>
        <div class="card-header bg-dark text-white text-center fw-bold fs-4">
          <i class="bi bi-flag-fill"></i> Manage Reports
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-hover table-striped align-middle text-center">
              <thead class="table-dark">
                <tr>
                  <th>ID</th>
                  <th>Reporter</th>
                  <th>Type</th>
                  <th>Reported ID</th>
                  <th>Reason</th>
                  <th>Evidence</th>
                  <th>Status</th>
                  <th>Created</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for r in reports %}
                <tr>
                  <td>{{ r.id }}</td>
                  <td>{{ r.reporter.name }}</td>
                  <td class="text-capitalize">{{ r.reported_type }}</td>
                  <td>{{ r.reported_id if r.reported_id else '-' }}</td>
                  <td style="max-width: 250px; white-space: pre-wrap;">{{ r.reason }}</td>

                  <!-- Evidence -->
                  <td>
                    {% if r.evidence_file %}
                      <button class="btn btn-sm btn-outline-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#evidenceModal{{ r.id }}">
                        View Evidence
                      </button>
                    {% else %}
                      <span class="text-muted">No File</span>
                    {% endif %}
                  </td>

                  <!-- Status -->
                  <td>
                    {% if r.status == "pending" %}
                      <span class="badge bg-warning text-dark px-3 py-2">Pending</span>
                    {% else %}
                      <span class="badge bg-success px-3 py-2">Resolved</span>
                    {% endif %}
                  </td>

                  <td>{{ r.date_report.strftime('%Y-%m-%d %H:%M') }}</td>

                  <!-- Action -->
                  <td>
                    <div class="d-grid gap-2">
                      {% if r.status == "pending" %}
                        <a href="{{ url_for('admin.resolve_report', report_id=r.id) }}" 
                           class="btn btn-success btn-sm">Resolve</a>
                      {% endif %}
                      <a href="{{ url_for('admin.delete_report', report_id=r.id) }}" 
                         class="btn btn-danger btn-sm">Delete</a>

                      <!-- Comment Button -->
                      <button class="btn btn-sm btn-outline-primary"
                              data-bs-toggle="modal"
                              data-bs-target="#commentModal{{ r.id }}">
                        Comment
                      </button>

                      <!-- Appeal Button -->
                      {% if r.appeal_text %}
                        <button class="btn btn-sm btn-info"
                                data-bs-toggle="modal"
                                data-bs-target="#appealModal{{ r.id }}">
                          View Appeal
                        </button>
                      {% endif %}
                    </div>
                  </td>
                </tr>

                <!-- Comment Modal -->
                <div class="modal fade" id="commentModal{{ r.id }}" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Edit Admin Comment (Report #{{ r.id }})</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <form method="POST" action="{{ url_for('admin.update_report', report_id=r.id) }}">
                        <div class="modal-body">
                          <textarea name="admin_comment" class="form-control" rows="4">{{ r.admin_comment or '' }}</textarea>
                        </div>
                        <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                          <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>

                <!-- Evidence Modal -->
                {% if r.evidence_file %}
                <div class="modal fade" id="evidenceModal{{ r.id }}" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Evidence for Report #{{ r.id }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body text-center">
                        <img src="{{ url_for('static', filename='uploads/reports/' ~ r.evidence_file) }}" 
                             class="img-fluid rounded shadow">
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}

                <!-- Appeal Modal -->
                {% if r.appeal_text %}
                <div class="modal fade" id="appealModal{{ r.id }}" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">Appeal for Report #{{ r.id }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body text-start">
                        <p><strong>Text:</strong> {{ r.appeal_text }}</p>
                        <p><strong>Status:</strong> {{ r.appeal_status }}</p>

                        {% if r.appeal_file %}
                          <button class="btn btn-sm btn-outline-primary"
                                  data-bs-toggle="modal"
                                  data-bs-target="#appealFileModal{{ r.id }}">
                            View Appeal File
                          </button>
                        {% endif %}

                        {% if r.appeal_deadline %}
                          <p class="mt-3"><strong>Deadline:</strong> {{ r.appeal_deadline.strftime('%Y-%m-%d %H:%M') }}</p>
                        {% endif %}
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Appeal File Modal -->
                {% if r.appeal_file %}
                <div class="modal fade" id="appealFileModal{{ r.id }}" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Appeal File for Report #{{ r.id }}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <img 
                        src="{{ url_for('static', filename='uploads/reports/' ~ r.appeal_file) }}"
                        data-fallback="{{ url_for('static', filename='uploads/' ~ r.appeal_file) }}"
                        class="img-fluid rounded shadow"
                        onerror="this.onerror=null; this.src=this.dataset.fallback;">
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                      </div>
                    </div>
                  </div>
                </div>
                {% endif %}
                {% endif %}
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}